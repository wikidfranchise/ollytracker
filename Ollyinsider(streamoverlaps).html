<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OllyInsider - Insider Filing CIK Intelligence (Unlimited)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }

        /* ============================================
           HEADER SECTION - Compact Version
           ============================================ */
        
        .header-wrapper {
            text-align: center;
            padding: 10px 20px 5px 20px;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 30px;
            padding: 0;
        }

        /* Logo Styling - Smaller but still prominent */
        .logo-img {
            height: 200px;
            width: auto;
            /* Makes logo white */
            filter: brightness(0) invert(1);
        }

        /* Title and Tagline Container */
        .title-section {
            text-align: left;
        }

        .page-title {
            color: #ffd700;
            margin: 0;
            font-size: 2.2em;
            font-weight: bold;
            line-height: 1;
        }

        .page-subtitle {
            color: white;
            font-size: 1.1em;
            opacity: 0.9;
            margin-top: 5px;
            line-height: 1.2;
        }

        .page-tagline {
            color: #feca57;
            font-size: 0.85em;
            opacity: 0.8;
            margin-top: 3px;
        }

        /* ============================================
           NAVIGATION BAR - Compact Style
           ============================================ */
        
        .nav-bar {
            display: flex;
            justify-content: center;
            gap: 8px;
            padding: 8px 15px;
            background: rgba(0,0,0,0.25);
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .nav-link {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 8px 14px;
            border-radius: 20px;
            text-decoration: none;
            font-weight: 600;
            font-size: 13px;
            display: inline-block;
            transition: all 0.3s ease;
        }

        .nav-link:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-1px);
        }

        /* Active page styling */
        .nav-link.active {
            background: #ffd700;
            color: #333;
            border: 1px solid #ffd700;
        }

        /* ============================================
           MAIN CONTAINER
           ============================================ */
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
            padding-top: 10px;
        }

        /* ============================================
           CALENDAR MODAL STYLES
           ============================================ */
        
        .calendar-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        
        .calendar-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 15px;
            padding: 25px;
            max-width: 700px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            color: #333;
        }
        
        .calendar-title {
            font-size: 22px;
            font-weight: bold;
            color: #667eea;
        }
        
        .calendar-close {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .calendar-nav {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .calendar-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            flex: 1;
        }
        
        .calendar-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 10px rgba(102, 126, 234, 0.4);
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 3px;
        }
        
        .calendar-day-header {
            text-align: center;
            font-weight: bold;
            padding: 8px;
            color: #667eea;
            border-bottom: 2px solid #e0e0e0;
            font-size: 12px;
        }
        
        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            color: #333;
            font-size: 12px;
        }
        
        .calendar-day:hover {
            background: #f0f0f0;
            transform: scale(1.05);
        }
        
        .calendar-day.has-filings {
            background: linear-gradient(135deg, #667eea20, #764ba220);
            border: 2px solid #667eea;
        }
        
        .calendar-day.selected {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .calendar-day-number {
            font-size: 14px;
            font-weight: bold;
        }
        
        .calendar-day-count {
            font-size: 9px;
            color: #667eea;
            margin-top: 2px;
        }
        
        .calendar-day.selected .calendar-day-count {
            color: white;
        }
        
        .calendar-day.other-month {
            opacity: 0.3;
            cursor: default;
        }
        
        .selected-date-info {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            color: #333;
        }
        
        .selected-date-title {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .day-export-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .day-export-btn {
            flex: 1;
            padding: 8px;
            border-radius: 5px;
            border: none;
            font-weight: bold;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .day-export-btn.json {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .day-export-btn.csv {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }
        
        .day-export-btn.excel {
            background: linear-gradient(135deg, #17a2b8, #138496);
            color: white;
        }
        
        .day-export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }
        
        .calendar-trigger-btn {
            background: linear-gradient(135deg, #ffd700, #feca57);
            color: #333;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            margin: 10px 0 20px 0;
            transition: all 0.3s;
            display: inline-block;
        }
        
        .calendar-trigger-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.4);
        }
        
        .stream-date-display {
            text-align: center;
            color: #ffd700;
            font-size: 18px;
            font-weight: bold;
            margin: 10px 0;
            padding: 10px;
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
        }

        /* ============================================
           COUNT DISPLAY SECTION
           ============================================ */
        
        .count-display {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            display: none;
            color: #333;
            text-align: center;
        }
        
        .count-number {
            font-size: 48px;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 10px 0;
        }
        
        .count-message {
            font-size: 16px;
            color: #666;
            margin: 10px 0;
        }
        
        .count-warning {
            background: #fff3cd;
            border: 1px solid #ffc107;
            color: #856404;
            padding: 10px;
            border-radius: 8px;
            margin-top: 15px;
        }

        /* ============================================
           CHUNK PROGRESS DISPLAY
           ============================================ */
        
        .chunk-progress {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            display: none;
            color: #333;
        }
        
        .chunk-header {
            font-size: 18px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 15px;
        }
        
        .chunk-status {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .chunk-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            transition: all 0.3s;
        }
        
        .chunk-item.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(102, 126, 234, 0); }
            100% { box-shadow: 0 0 0 0 rgba(102, 126, 234, 0); }
        }
        
        .chunk-item.complete {
            background: #28a745;
            color: white;
        }
        
        .chunk-item.error {
            background: #dc3545;
            color: white;
        }
        
        .chunk-spinner {
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: none;
        }
        
        .chunk-item.active .chunk-spinner {
            display: block;
        }
        
        .chunk-check {
            color: white;
            font-size: 20px;
            display: none;
        }
        
        .chunk-item.complete .chunk-check {
            display: block;
        }
        
        .chunk-date-range {
            font-weight: bold;
            color: #ffd700;
            background: rgba(0,0,0,0.2);
            padding: 2px 8px;
            border-radius: 4px;
            margin: 0 5px;
        }

        /* ============================================
           ORIGINAL OLLYINSIDER STYLES
           ============================================ */
        
        .controls {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .control-group {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        select, input {
            padding: 10px 15px;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-size: 16px;
            background: white;
        }
        
        button {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Filing Boats Container */
        .boats-container {
            position: relative;
            min-height: 250px;
            margin-bottom: 40px;
        }
        
        .boat-track {
            background: rgba(255, 255, 255, 0.1);
            height: 180px;
            border-radius: 90px;
            position: relative;
            overflow: hidden;
            margin: 20px 0;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        /* Individual Filing Boat */
        .filing-boat {
            position: absolute;
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            width: 250px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
        }
        
        .filing-boat:hover {
            transform: translateY(-50%) scale(1.05);
            z-index: 10000 !important;
            box-shadow: 0 8px 30px rgba(0,0,0,0.3);
        }
        
        @keyframes sailBoat {
            from {
                left: -260px;
            }
            to {
                left: 100%;
            }
        }
        
        /* Filing Cards Grid */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .filing-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .filing-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .filing-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .form-type {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
        }
        
        .filing-date {
            color: #666;
            font-size: 14px;
        }
        
        .ticker-hot {
            margin: 10px 0;
        }
        
        .ticker-links {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        
        .ticker-link {
            padding: 6px 10px;
            border-radius: 6px;
            text-decoration: none;
            font-size: 12px;
            font-weight: bold;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 3px;
        }
        
        .ticker-link.yahoo {
            background: linear-gradient(135deg, #7c3aed, #a855f7);
            color: white;
        }
        
        .ticker-link.yahoo:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(168, 85, 247, 0.4);
        }
        
        .ticker-link.google {
            background: linear-gradient(135deg, #4285f4, #34a853);
            color: white;
        }
        
        .ticker-link.google:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(66, 133, 244, 0.4);
        }
        
        .ticker-link.tradingview {
            background: linear-gradient(135deg, #2962ff, #0d47a1);
            color: white;
        }
        
        .ticker-link.tradingview:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(41, 98, 255, 0.4);
        }
        
        .ticker-link.charts {
            background: linear-gradient(135deg, #ff6b6b, #ff8e53);
            color: white;
        }
        
        .ticker-link.charts:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.4);
        }
        
        .ticker-link.finviz {
            background: linear-gradient(135deg, #11998e, #38ef7d);
            color: white;
        }
        
        .ticker-link.finviz:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(56, 239, 125, 0.4);
        }
        
        .ticker-link.seeking {
            background: linear-gradient(135deg, #f2994a, #f2c94c);
            color: white;
        }
        
        .ticker-link.seeking:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(242, 153, 74, 0.4);
        }
         
        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        
        .cik-section {
            margin: 15px 0;
        }
        
        .cik-label {
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .cik-label .emoji {
            font-size: 18px;
        }
        
        .cik-info {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 8px;
        }
        
        .cik-number {
            font-family: monospace;
            font-size: 14px;
            color: #667eea;
            font-weight: bold;
        }
        
        .cik-name {
            color: #333;
            margin-top: 5px;
        }
        
        .cik-links {
            display: flex;
            gap: 10px;
            margin-top: 8px;
        }
        
        .cik-link {
            padding: 5px 10px;
            background: #e9ecef;
            border-radius: 5px;
            text-decoration: none;
            color: #495057;
            font-size: 12px;
            transition: background 0.2s;
        }
        
        .cik-link:hover {
            background: #667eea;
            color: white;
        }
        
        .filing-link {
            display: inline-block;
            margin-top: 10px;
            padding: 8px 15px;
            background: #28a745;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            font-size: 14px;
            transition: background 0.2s;
        }
        
        .filing-link:hover {
            background: #218838;
        }
        
        .stats {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            color: #333;
        }
        
        .loading {
            text-align: center;
            color: white;
            font-size: 20px;
            padding: 40px;
        }
        
        .spinner {
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .boat-cik {
            font-size: 12px;
            color: #667eea;
            font-weight: bold;
            margin: 2px 0;
        }
        
        .boat-name {
            font-size: 11px;
            color: #333;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .boat-form {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #764ba2;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: bold;
        }
        
        .ollytracker-watermark {
            text-align: center;
            color: rgba(255, 255, 255, 0.7);
            font-size: 12px;
            margin-top: 20px;
            font-style: italic;
        }
        
        /* Progress bar for pagination */
        .progress-container {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            display: none;
        }
        
        .progress-bar {
            background: #e9ecef;
            border-radius: 10px;
            height: 30px;
            position: relative;
            overflow: hidden;
        }
        
        .progress-fill {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
        }
        
        .progress-text {
            color: #333;
            margin-top: 10px;
            font-size: 14px;
            text-align: center;
        }

        /* ============================================
           EXPORT STYLES
           ============================================ */
        
        .export-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            display: none;
        }
        
        .export-header {
            color: #333;
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .export-controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .export-btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
        }
        
        .export-btn.json {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .export-btn.csv {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }
        
        .export-btn.excel {
            background: linear-gradient(135deg, #17a2b8, #138496);
            color: white;
        }
        
        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
            }
            
            .logo-img {
                height: 150px;
            }
            
            .title-section {
                text-align: center;
            }
            
            .page-title {
                font-size: 1.8em;
            }
            
            .page-subtitle {
                font-size: 1em;
            }
            
            .nav-link {
                padding: 6px 12px;
                font-size: 12px;
            }
            
            .cards-grid {
                grid-template-columns: 1fr;
            }
            
            .export-controls {
                flex-direction: column;
                width: 100%;
            }
            
            .export-btn {
                width: 100%;
            }
        }

        @media (max-width: 480px) {
            .logo-img {
                height: 120px;
            }
            
            .page-title {
                font-size: 1.3em;
            }
            
            .page-subtitle {
                font-size: 0.9em;
            }
            
            .nav-bar {
                gap: 5px;
                padding: 6px 10px;
            }
        }
        
    </style>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
</head>
<body>
    <!-- HEADER SECTION - Outside Container -->
    <div class="header-wrapper">
        <div class="header-content">
            <!-- Logo -->
            <img src="OllyTracker Yacht Logo.png" alt="OllyTracker" class="logo-img">
            
            <!-- Title Section -->
            <div class="title-section">
                <h1 class="page-title">🕵️ OllyInsider - Unlimited Filing Intelligence</h1>
                <p class="page-subtitle">Advanced CIK Analysis & Real-time Insider Trading Monitor</p>
                <p class="page-tagline">No Limits • Track Every Move • Analyze Every Filing</p>
            </div>
        </div>
    </div>
    
    <nav class="nav-bar">
        <a href="OllyStream.html" class="nav-link">⚡ OllyStream</a>
        <a href="OllyTracker.html" class="nav-link">📈 OllyTracker</a>
        <a href="OllyCortex.html" class="nav-link">🧠 OllyCortex</a>
        <a href="OllyInsider.html" class="nav-link active">🕵️ OllyInsider</a>
        <a href="OllyComp.html" class="nav-link">💵 OllyComp</a>
        <a href="OllyEnforcer.html" class="nav-link">⚖️ OllyEnforcer</a>
        <a href="OllyLookup.html" class="nav-link">🔍 OllyLookup</a>
        <a href="OllyAuditor.html" class="nav-link">📊 OllyAuditor</a>
    </nav>
    
    <div class="container">
        <div class="controls">
            <div class="control-group">
                <select id="yearSelect">
                    <option value="2025" selected>2025</option>
                    <option value="2024">2024</option>
                    <option value="2023">2023</option>
                    <option value="2022">2022</option>
                    <option value="2021">2021</option>
                    <option value="2020">2020</option>
                </select>
                
                <select id="monthSelect">
                    <option value="1">January</option>
                    <option value="2">February</option>
                    <option value="3">March</option>
                    <option value="4">April</option>
                    <option value="5">May</option>
                    <option value="6">June</option>
                    <option value="7">July</option>
                    <option value="8">August</option>
                    <option value="9">September</option>
                    <option value="10">October</option>
                    <option value="11">November</option>
                    <option value="12">December</option>
                </select>
                
                <select id="formSelect">
                    <option value="all">All Forms (3, 4, 5, 144)</option>
                    <option value="3">Form 3 Only</option>
                    <option value="4" selected>Form 4 Only</option>
                    <option value="5">Form 5 Only</option>
                    <option value="144">Form 144 Only</option>
                </select>
                
                <select id="recordsSelect">
                    <option value="50">50 Records</option>
                    <option value="100">100 Records</option>
                    <option value="200">200 Records</option>
                    <option value="300">300 Records</option>
                    <option value="500">500 Records</option>
                    <option value="1000">1000 Records</option>
                    <option value="unlimited" selected>UNLIMITED (Entire Month)</option>
                </select>
                
                <button onclick="fetchFilings()">🔍 Fetch Filings</button>
                <button onclick="toggleView()">🔄 Toggle View</button>
                <button onclick="showWatchlist()" style="background: #28a745;">📋 Watchlist (<span id="watchlistCount">0</span>)</button>
            </div>
        </div>
                      
        <!-- Count Display Section -->
        <div id="countDisplay" class="count-display">
            <div class="count-message">Total filings found for selected criteria:</div>
            <div id="countNumber" class="count-number">0</div>
            <div id="countDetails" class="count-message"></div>
            <div id="countWarning" class="count-warning" style="display: none;"></div>
        </div>
        
        <!-- Progress Bar for Pagination -->
        <div id="progressContainer" class="progress-container">
            <div class="progress-bar">
                <div id="progressFill" class="progress-fill">0%</div>
            </div>
            <div id="progressText" class="progress-text">Loading filings...</div>
        </div>
        
        <!-- Chunk Progress Display -->
        <div id="chunkProgress" class="chunk-progress">
            <div class="chunk-header">🚀 Fetching Data in Chunks</div>
            <div id="chunkStatus" class="chunk-status"></div>
        </div>
        
        <div id="statsDiv" class="stats" style="display:none;"></div>
        
        <!-- EXPORT SECTION -->
        <div id="exportSection" class="export-section">
            <div class="export-header">
                💾 Export Current Data
            </div>
            <div class="export-controls">
                <button class="export-btn json" onclick="exportCurrentData('json')">
                    📄 Export as JSON
                </button>
                <button class="export-btn csv" onclick="exportCurrentData('csv')">
                    📊 Export as CSV
                </button>
                <button class="export-btn excel" onclick="exportCurrentData('excel')">
                    📈 Export as Excel
                </button>
            </div>
        </div>
        
        <!-- CALENDAR MODAL -->
        <div id="calendarModal" class="calendar-modal">
            <div class="calendar-content">
                <div class="calendar-header">
                    <div class="calendar-title">📅 Select Filing Date</div>
                    <button class="calendar-close" onclick="closeCalendar()">✕ Close</button>
                </div>
                <div class="calendar-nav">
                    <button class="calendar-btn" onclick="previousMonth()">← Previous</button>
                    <button class="calendar-btn" onclick="currentMonth()">Today</button>
                    <button class="calendar-btn" onclick="nextMonth()">Next →</button>
                </div>
                <div class="calendar-grid" id="calendarGrid"></div>
                <div id="selectedDateInfo" class="selected-date-info" style="display: none;">
                    <div class="selected-date-title" id="selectedDateTitle"></div>
                    <div id="selectedDateStats"></div>
                    <div class="day-export-buttons">
                        <button class="day-export-btn json" onclick="exportDayData('json')">
                            📄 JSON
                        </button>
                        <button class="day-export-btn csv" onclick="exportDayData('csv')">
                            📊 CSV
                        </button>
                        <button class="day-export-btn excel" onclick="exportDayData('excel')">
                            📈 Excel
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="boatsContainer" class="boats-container" style="display:none;">
            <h2 style="color: white; margin-bottom: 20px;">⛵ Insider Stream by Calendar Day</h2>
            <button class="calendar-trigger-btn" onclick="openCalendar()" style="display: none;" id="calendarButtonBoats">📅 Select Date</button>
            <div id="streamDateDisplay" class="stream-date-display">All Filings</div>
            <div class="boat-track" id="boatTrack"></div>
        </div>
        
        <div id="cardsContainer">
            <h2 style="color: white; margin-bottom: 20px;">📇 OllyCards</h2>
            <button class="calendar-trigger-btn" onclick="openCalendar()" style="display: none;" id="calendarButtonCards">📅 View Calendar</button>
            <div id="calendarNotice" style="background: rgba(255,215,0,0.2); color: #ffd700; padding: 10px; border-radius: 8px; margin-bottom: 15px; text-align: center; font-size: 14px;">
                📅 Calendar will be available after fetching filings
            </div>
            <div id="cardsGrid" class="cards-grid"></div>
        </div>
        
        <div id="loadingDiv" class="loading" style="display:none;">
            <div class="spinner"></div>
            OllyTracker is loading filings...
        </div>
        
        <p class="ollytracker-watermark">Powered by OllyTracker Analytics Engine - Unlimited Edition</p>
    </div>

    <script>
        const API_KEY = 'fad7a2d6ac4447db3d2bdcd70003e2ea41ad47adedfd617fa4185c755fab3efd';
        
        let currentView = 'cards'; // 'cards' or 'boats'
        let filings = [];
        let displayedFilings = 100; // Start by showing only 100
        let boatInterval; // Store interval globally so we can clear it
        let boatCleanupInterval; // Store cleanup interval
        let currentCalendarMonth = new Date().getMonth();
        let currentCalendarYear = new Date().getFullYear();
        let selectedDate = null;
        let filteredFilings = []; // Filings filtered by selected date
                
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize with current month
            const currentMonth = new Date().getMonth() + 1;
            document.getElementById('monthSelect').value = currentMonth;
            
            // Set year to 2025
            document.getElementById('yearSelect').value = '2025';
            
            // Ensure calendar buttons are hidden initially
            document.getElementById('calendarButtonCards').style.display = 'none';
            document.getElementById('calendarButtonBoats').style.display = 'none';
            
            // Ensure export section is hidden initially
            document.getElementById('exportSection').style.display = 'none';
        });
        
        // Replace the old watchlist variable with this new structure
        let watchlist = {
            individuals: new Map(), // Map of CIK -> name
            companies: new Map()    // Map of ticker -> name
        };
        
        // Updated addToWatchlist function
        function addToWatchlist(type, identifier, name) {
            if (type === 'individual') {
                watchlist.individuals.set(identifier, name);
                showNotification(`✅ ${name} (CIK: ${identifier}) added to watchlist`);
            } else if (type === 'company') {
                watchlist.companies.set(identifier, name);
                showNotification(`✅ ${identifier} added to watchlist`);
            }
            updateWatchlistCount();
        }        
        
        // Updated watchlist count function
        function updateWatchlistCount() {
            const totalCount = watchlist.individuals.size + watchlist.companies.size;
            document.getElementById('watchlistCount').textContent = totalCount;
        }

        // Updated showWatchlist function
        function showWatchlist() {
            const totalCount = watchlist.individuals.size + watchlist.companies.size;
            
            if (totalCount === 0) {
                alert('OllyTracker Watchlist is empty. Add individuals or companies from the filing cards!');
                return;
            }

            let watchlistHTML = '<h3>📋 Your OllyTracker Watchlist</h3>';
            
            // Show Individuals section
            if (watchlist.individuals.size > 0) {
                watchlistHTML += '<h4 style="color: #667eea; margin-top: 20px;">👤 Individuals (Insiders)</h4>';
                watchlistHTML += '<div style="margin: 10px 0;">';
                watchlist.individuals.forEach((name, cik) => {
                    watchlistHTML += `
                        <a href="https://www.sec.gov/cgi-bin/browse-edgar?CIK=${cik}" target="_blank" 
                           style="display: inline-block; background: linear-gradient(135deg, #667eea, #764ba2); 
                                  color: white; padding: 8px 15px; border-radius: 20px; margin: 5px;
                                  text-decoration: none; font-weight: bold; font-size: 13px;"
                           title="${name} OTCV">
                            ${name} <span style="font-size: 11px; opacity: 0.8;">(${cik})</span>
                        </a>
                    `;
                });
                watchlistHTML += '</div>';
            }

            // Show Companies section
            if (watchlist.companies.size > 0) {
                watchlistHTML += '<h4 style="color: #28a745; margin-top: 20px;">🏢 Companies</h4>';
                watchlistHTML += '<div style="margin: 10px 0;">';
                watchlist.companies.forEach((name, ticker) => {
                    watchlistHTML += `
                        <a href="https://finance.yahoo.com/quote/${ticker}" target="_blank" 
                           style="display: inline-block; background: linear-gradient(135deg, #28a745, #20c997); 
                                  color: white; padding: 8px 15px; border-radius: 20px; margin: 5px;
                                  text-decoration: none; font-weight: bold;">
                            ${ticker} <span style="font-size: 11px; opacity: 0.8;">${name ? `- ${name.substring(0, 20)}${name.length > 20 ? '...' : ''}` : ''}</span>
                        </a>
                    `;
                });
                watchlistHTML += '</div>';
            }
            
            // Add summary
            watchlistHTML += `
                <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #e0e0e0; color: #666; font-size: 14px;">
                    <strong>Summary:</strong> ${watchlist.individuals.size} individuals, ${watchlist.companies.size} companies
                </div>
            `;
            
            // Create and show modal
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: white; padding: 30px; border-radius: 15px;
                box-shadow: 0 10px 40px rgba(0,0,0,0.3); z-index: 1000;
                max-width: 600px; max-height: 500px; overflow-y: auto;
                color: #333;
            `;
            modal.innerHTML = watchlistHTML + '<br><button onclick="this.parentElement.remove()" style="margin-top: 20px;">Close</button>';
            document.body.appendChild(modal);
        }
        
        function showNotification(message) {
            const notif = document.createElement('div');
            notif.textContent = message;
            notif.style.cssText = `
                position: fixed; top: 20px; right: 20px; 
                background: linear-gradient(135deg, #28a745, #20c997);
                color: white; padding: 15px 25px; border-radius: 10px;
                box-shadow: 0 5px 20px rgba(40, 167, 69, 0.4);
                animation: slideIn 0.3s ease-out;
                z-index: 2000;
            `;
            document.body.appendChild(notif);
            setTimeout(() => notif.remove(), 3000);
        }
        
        // Calendar functions
        function openCalendar() {
            document.getElementById('calendarModal').style.display = 'block';
            buildCalendar();
        }
        
        function closeCalendar() {
            document.getElementById('calendarModal').style.display = 'none';
        }
        
        // Updated toggleView
        function toggleView() {
            if (currentView === 'cards') {
                currentView = 'boats';
                document.getElementById('cardsContainer').style.display = 'none';
                document.getElementById('boatsContainer').style.display = 'block';
                
                // Only show calendar button if we have data
                if (filings.length > 0) {
                    document.getElementById('calendarButtonBoats').style.display = 'inline-block';
                }
                
                displayBoats();
            } else {
                currentView = 'cards';
                // Clear boat interval when switching back to cards
                if (boatInterval) {
                    clearInterval(boatInterval);
                }
                if (boatCleanupInterval) {
                    clearInterval(boatCleanupInterval);
                }
                document.getElementById('cardsContainer').style.display = 'block';
                document.getElementById('boatsContainer').style.display = 'none';
                
                // Only show calendar button if we have data
                if (filings.length > 0) {
                    document.getElementById('calendarButtonCards').style.display = 'inline-block';
                }
            }
        }
        
        // Calendar functions
        function buildCalendar() {
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            
            // Add day headers
            const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayHeaders.forEach(day => {
                const header = document.createElement('div');
                header.className = 'calendar-day-header';
                header.textContent = day;
                grid.appendChild(header);
            });
            
            // Get first day of month and number of days
            const firstDay = new Date(currentCalendarYear, currentCalendarMonth, 1);
            const lastDay = new Date(currentCalendarYear, currentCalendarMonth + 1, 0);
            const startPadding = firstDay.getDay();
            const daysInMonth = lastDay.getDate();
            
            // Create filing count map by date - FIXED DATE PARSING
            const filingsByDate = {};
            filings.forEach(filing => {
                if (!filing.filedAt) return;
                
                // Handle different date formats more robustly
                let dateObj;
                const filingDateStr = filing.filedAt;
                
                // Parse the date properly
                if (filingDateStr.includes('T')) {
                    // ISO format: 2022-07-15T10:30:00
                    dateObj = new Date(filingDateStr.split('T')[0] + 'T12:00:00'); // Use noon to avoid timezone issues
                } else {
                    dateObj = new Date(filingDateStr);
                }
                
                // Create the date key ensuring proper month/day padding
                const year = dateObj.getFullYear();
                const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                const day = String(dateObj.getDate()).padStart(2, '0');
                const dateKey = `${year}-${month}-${day}`;
                
                filingsByDate[dateKey] = (filingsByDate[dateKey] || 0) + 1;
            });

            console.log(`Calendar: Found filings for ${Object.keys(filingsByDate).length} different dates`);
            console.log('Filing dates sample:', Object.keys(filingsByDate).slice(0, 5));
            
            console.log('Filings by date (improved):', filingsByDate); // Debug log
            
            // Add padding days from previous month
            for (let i = 0; i < startPadding; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day other-month';
                grid.appendChild(emptyDay);
            }
            
            // Add days of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                
                // Create consistent date key for checking
                const year = currentCalendarYear;
                const month = String(currentCalendarMonth + 1).padStart(2, '0');
                const dayStr = String(day).padStart(2, '0');
                const dateKey = `${year}-${month}-${dayStr}`;
                const filingCount = filingsByDate[dateKey] || 0;
                
                const currentDate = new Date(currentCalendarYear, currentCalendarMonth, day);
                
                if (filingCount > 0) {
                    dayElement.classList.add('has-filings');
                }
                
                if (selectedDate && 
                    selectedDate.getFullYear() === currentCalendarYear &&
                    selectedDate.getMonth() === currentCalendarMonth &&
                    selectedDate.getDate() === day) {
                    dayElement.classList.add('selected');
                }
                
                // Check if it's a weekday (Monday-Friday)
                const dayOfWeek = currentDate.getDay();
                const isWeekday = dayOfWeek >= 1 && dayOfWeek <= 5;

                // Always show filing count on weekdays, show on weekends only if > 0
                dayElement.innerHTML = `
                    <div class="calendar-day-number">${day}</div>
                    <div class="calendar-day-count" style="${filingCount > 0 ? 'color: #667eea; font-weight: bold;' : 'color: #999; font-size: 10px;'}">
                        ${filingCount.toLocaleString()} filing${filingCount !== 1 ? 's' : ''}
                    </div>
                `;

                // Add visual distinction for weekdays with no filings (potential data issue)
                if (isWeekday && filingCount === 0) {
                    dayElement.style.background = 'rgba(255, 215, 0, 0.1)'; // Light yellow highlight
                }

               
                dayElement.onclick = () => selectDate(currentDate);
                
                grid.appendChild(dayElement);
            }
            
            // Update month/year display
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                               'July', 'August', 'September', 'October', 'November', 'December'];
            document.querySelector('.calendar-title').textContent = 
                `📅 ${monthNames[currentCalendarMonth]} ${currentCalendarYear}`;
        }
        
        function selectDate(date) {
            selectedDate = date;
            
            // Filter filings for selected date - IMPROVED DATE COMPARISON
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const dateKey = `${year}-${month}-${day}`;
            
            filteredFilings = filings.filter(filing => {
                // Extract just the date part from the filing timestamp
                const filingDateStr = filing.filedAt;
                const datePart = filingDateStr.split('T')[0];
                return datePart === dateKey;
            });
            
            console.log(`Selected date: ${dateKey}, Found ${filteredFilings.length} filings`); // Debug log
            
            // Update calendar display
            buildCalendar();
            
            // Update selected date info in modal
            const infoDiv = document.getElementById('selectedDateInfo');
            const titleDiv = document.getElementById('selectedDateTitle');
            const statsDiv = document.getElementById('selectedDateStats');
            
            infoDiv.style.display = 'block';
            titleDiv.textContent = `Selected: ${date.toLocaleDateString()}`;
            statsDiv.innerHTML = `
                <strong>${filteredFilings.length} filings</strong> on this date<br>
                <button onclick="applyDateFilter()" style="margin-top: 10px; width: 100%;">
                    Apply Filter to Stream
                </button>
            `;
            
            // Update stream date display
            document.getElementById('streamDateDisplay').textContent = 
                `Showing filings for: ${date.toLocaleDateString()} (${filteredFilings.length} filings)`;
        }
        
        function applyDateFilter() {
            closeCalendar();
            displayBoats();
        }
        
        function previousMonth() {
            currentCalendarMonth--;
            if (currentCalendarMonth < 0) {
                currentCalendarMonth = 11;
                currentCalendarYear--;
            }
            buildCalendar();
        }
        
        function nextMonth() {
            currentCalendarMonth++;
            if (currentCalendarMonth > 11) {
                currentCalendarMonth = 0;
                currentCalendarYear++;
            }
            buildCalendar();
        }
        
        function currentMonth() {
            const today = new Date();
            currentCalendarMonth = today.getMonth();
            currentCalendarYear = today.getFullYear();
            selectDate(today);
        }
        
        // Export day data function
        function exportDayData(format) {
            if (!filteredFilings || filteredFilings.length === 0) {
                showNotification('⌠No data to export for selected date');
                return;
            }
            exportCurrentData(format, true); // Pass true to indicate day export
        }
        
        // Improved displayBoats with OllyStream-style streaming
        function displayBoats() {
            const boatTrack = document.getElementById('boatTrack');
            boatTrack.innerHTML = '';
            
            // Clear any existing intervals
            if (boatInterval) {
                clearInterval(boatInterval);
            }
            if (boatCleanupInterval) {
                clearInterval(boatCleanupInterval);
            }
            
            // Use filtered filings if a date is selected, otherwise use all filings
            const filingsToShow = selectedDate && filteredFilings.length > 0 ? filteredFilings : filings;
            const maxBoats = Math.min(filingsToShow.length, 50);
            
            // Update date display
            if (selectedDate && filteredFilings.length > 0) {
                document.getElementById('streamDateDisplay').textContent = 
                    `Filings for: ${selectedDate.toLocaleDateString()} (${filteredFilings.length} total)`;
            } else {
                document.getElementById('streamDateDisplay').textContent = 
                    `All Filings (${filings.length} total)`;
            }
            
            if (maxBoats === 0) {
                boatTrack.innerHTML = '<p style="color: white; text-align: center; padding: 50px;">No filings to display</p>';
                return;
            }
            
            let boatIndex = 0;
            let activeBoats = [];
            
            // Function to create a boat with proper spacing
            function createNewBoat() {
                if (boatIndex >= maxBoats) {
                    boatIndex = 0; // Loop back to start
                }
                
                const boat = createFilingBoat(filingsToShow[boatIndex], boatIndex);
                
                // Set initial position off-screen to the left
                boat.style.left = '-260px';
                boat.style.animation = 'none';
                boat.style.transition = 'left 35s linear';
                
                boatTrack.appendChild(boat);
                activeBoats.push(boat);
                
                // Start the animation after a brief delay
                setTimeout(() => {
                    boat.style.left = 'calc(100% + 260px)';
                }, 50);
                
                // Remove boat after animation completes
                setTimeout(() => {
                    if (boat.parentNode) {
                        boat.remove();
                    }
                    activeBoats = activeBoats.filter(b => b !== boat);
                }, 36000);
                
                boatIndex++;
            }
            
            // Create first boat immediately
            createNewBoat();
            
            // Create new boats at regular intervals
            boatInterval = setInterval(() => {
                // Only create new boat if we have less than 6 active boats
                if (activeBoats.length < 6) {
                    createNewBoat();
                }
            }, 6000); // Space boats 6 seconds apart for smooth stream
            
            // Clean up boats that have left the screen
            boatCleanupInterval = setInterval(() => {
                const boats = boatTrack.querySelectorAll('.filing-boat');
                boats.forEach(boat => {
                    const rect = boat.getBoundingClientRect();
                    const trackRect = boatTrack.getBoundingClientRect();
                    
                    // Remove boats that are off screen to the right
                    if (rect.left > trackRect.right + 50) {
                        boat.remove();
                        activeBoats = activeBoats.filter(b => b !== boat);
                    }
                });
                
                // Also clean up the activeBoats array
                activeBoats = activeBoats.filter(boat => boat.parentNode);
            }, 500);
        }
        
        // NEW: Get total count for a date range (with multiple form types support)
        async function getTotalCount(formTypes, startDate, endDate) {
            if (!Array.isArray(formTypes)) {
                formTypes = [formTypes];
            }
            
            let totalCount = 0;
            
            for (const formType of formTypes) {
                const endpoint = formType === '144' 
                    ? 'https://api.sec-api.io/form-144'
                    : 'https://api.sec-api.io/insider-trading';
                
                const queryField = formType === '144' ? 'formType' : 'documentType';
                
                const countPayload = {
                    query: `${queryField}:${formType} AND filedAt:[${startDate} TO ${endDate}]`,
                    from: "0",
                    size: "1", // We only need the total count
                    sort: [{ "filedAt": { "order": "desc" }}]
                };
                
                try {
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': API_KEY
                        },
                        body: JSON.stringify(countPayload)
                    });
                    
                    if (!response.ok) {
                        console.error(`Count query failed for Form ${formType}`);
                        continue;
                    }
                    
                    const data = await response.json();
                    const count = data.total?.value || data.total || 0;
                    console.log(`Form ${formType} count: ${count}`);
                    totalCount += count;
                } catch (error) {
                    console.error(`Error getting count for Form ${formType}:`, error);
                }
            }
            
            return totalCount;
        }
        
        // NEW: Display count information
        function displayCountInfo(totalCount, formType, year, month) {
            const countDisplay = document.getElementById('countDisplay');
            const countNumber = document.getElementById('countNumber');
            const countDetails = document.getElementById('countDetails');
            const countWarning = document.getElementById('countWarning');
            
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            const monthName = monthNames[parseInt(month) - 1];
            
            countDisplay.style.display = 'block';
            
            // If count is exactly 10,000, show 10,000+
            if (totalCount === 10000) {
                countNumber.innerHTML = '10,000<span style="color: #ffd700;">+</span>';
            } else {
                countNumber.textContent = totalCount.toLocaleString();
            }
            
            const formDesc = formType === 'all' ? 'All Forms' : `Form ${formType}`;
            countDetails.textContent = `${formDesc} • ${monthName} ${year}`;
            
            if (totalCount > 10000 || totalCount === 10000) {
                countWarning.style.display = 'block';
                countWarning.innerHTML = `⚠️ Your download will be in multiple steps due to high volume. All downloads will be combined in a single download file.`;
            } else {
                countWarning.style.display = 'none';
            }
            
            // Auto-hide after a moment to show progress
            setTimeout(() => {
                countDisplay.style.display = 'none';
            }, 5000);
        }
                
        // NEW: Create date chunks based on total count
        function createDateChunks(startDate, endDate, totalCount, chunkSize = 9500) {
            const chunks = [];
            
            if (totalCount <= chunkSize) {
                // Single chunk is enough
                chunks.push({ 
                    start: startDate, 
                    end: endDate, 
                    estimatedCount: totalCount,
                    dateRange: `${startDate} to ${endDate}`
                });
                return chunks;
            }
            
            // Calculate how many chunks we need
            const numChunks = Math.ceil(totalCount / chunkSize);
            
            // Split the date range into equal parts
            const start = new Date(startDate);
            const end = new Date(endDate);
            const totalDays = Math.floor((end - start) / (1000 * 60 * 60 * 24)) + 1;
            const daysPerChunk = Math.ceil(totalDays / numChunks);
            
            let currentStart = new Date(start);
            for (let i = 0; i < numChunks; i++) {
                const chunkStart = currentStart.toISOString().split('T')[0];
                currentStart.setDate(currentStart.getDate() + daysPerChunk - 1);
                
                // Make sure we don't go past the end date
                if (currentStart > end) {
                    currentStart = new Date(end);
                }
                
                const chunkEnd = currentStart.toISOString().split('T')[0];
                
                chunks.push({
                    start: chunkStart,
                    end: chunkEnd,
                    estimatedCount: Math.ceil(totalCount / numChunks),
                    dateRange: `${chunkStart} to ${chunkEnd}`
                });
                
                // Move to next day for next chunk
                currentStart.setDate(currentStart.getDate() + 1);
                
                // Break if we've reached the end
                if (currentStart > end) {
                    break;
                }
            }
            
            return chunks;
        }
        
        // NEW: Display chunk progress with date ranges
        function displayChunkProgress(chunks, currentChunkIndex = -1, formType = '') {
            const chunkProgress = document.getElementById('chunkProgress');
            const chunkStatus = document.getElementById('chunkStatus');
            
            chunkProgress.style.display = 'block';
            
            let html = '';
            chunks.forEach((chunk, index) => {
                let className = 'chunk-item';
                if (index === currentChunkIndex) {
                    className += ' active';
                } else if (index < currentChunkIndex) {
                    className += ' complete';
                }
                
                const formLabel = formType ? `Form ${formType} - ` : '';
                
                html += `
                    <div class="${className}">
                        <div class="chunk-spinner"></div>
                        <div class="chunk-check">✔</div>
                        <div style="flex: 1;">
                            <strong>${formLabel}Chunk ${index + 1}/${chunks.length}</strong>
                            <span class="chunk-date-range">${chunk.dateRange}</span>
                            ${chunk.actualCount ? ` • Retrieved: ${chunk.actualCount.toLocaleString()} filings` : ` • Est: ~${chunk.estimatedCount.toLocaleString()} filings`}
                        </div>
                    </div>
                `;
            });
            
            chunkStatus.innerHTML = html;
        }
        
        // NEW: Fetch single chunk with pagination
        async function fetchChunk(formType, chunk, progressCallback) {
            const batchSize = 50;
            let allFilings = [];
            let fetchedCount = 0;
            
            const endpoint = formType === '144' 
                ? 'https://api.sec-api.io/form-144'
                : 'https://api.sec-api.io/insider-trading';
            
            const queryField = formType === '144' ? 'formType' : 'documentType';
            
            // Get actual count for this specific chunk
            const chunkTotal = await getTotalCount(formType, chunk.start, chunk.end);
            console.log(`Actual count for chunk ${chunk.dateRange}: ${chunkTotal}`);
            chunk.actualCount = chunkTotal;
            
            const maxToFetch = Math.min(chunkTotal, 10000); // API limit per query
            
            let batchCount = 0;
            while (fetchedCount < maxToFetch) {
                const fromIndex = batchCount * batchSize;
                
                if (fromIndex >= 10000) {
                    console.log('Reached API limit for this chunk');
                    break;
                }
                
                const currentBatchSize = Math.min(batchSize, maxToFetch - fetchedCount);
                
                const payload = {
                    query: `${queryField}:${formType} AND filedAt:[${chunk.start} TO ${chunk.end}]`,
                    from: fromIndex.toString(),
                    size: currentBatchSize.toString(),
                    sort: [{ "filedAt": { "order": "desc" }}]
                };
                
                try {
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': API_KEY
                        },
                        body: JSON.stringify(payload)
                    });
                    
                    if (!response.ok) {
                        console.error(`Batch ${batchCount + 1} failed`);
                        break;
                    }
                    
                    const data = await response.json();
                    const results = data.transactions || data.data || [];
                    
                    if (results.length > 0) {
                        allFilings = allFilings.concat(results);
                        fetchedCount += results.length;
                        batchCount++;
                        
                        if (progressCallback) {
                            progressCallback(fetchedCount, maxToFetch, chunk.dateRange);
                        }
                        
                        if (results.length < currentBatchSize) {
                            break;
                        }
                    } else {
                        break;
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, 200));
                } catch (error) {
                    console.error('Error in batch fetch:', error);
                    break;
                }
            }
            
            chunk.fetched = allFilings.length;
            return allFilings;
        }
        
    window.fetchFilings = async function() {
        const year = document.getElementById('yearSelect').value;
        const month = document.getElementById('monthSelect').value;
        const formType = document.getElementById('formSelect').value;
        const recordsOption = document.getElementById('recordsSelect').value;
        const loadingDiv = document.getElementById('loadingDiv');
        const progressContainer = document.getElementById('progressContainer');
        const chunkProgress = document.getElementById('chunkProgress');
        const countDisplay = document.getElementById('countDisplay');
        const button = event.target;
        
        console.log('Starting fetch with params:', { year, month, formType, recordsOption });
        
        button.disabled = true;
        loadingDiv.style.display = 'block';
        document.getElementById('cardsGrid').innerHTML = '';
        filings = [];
        filteredFilings = []; // Reset filtered filings
        selectedDate = null; // Reset selected date
        displayedFilings = 100;
        
        // Hide calendar buttons and show notice
        document.getElementById('calendarButtonCards').style.display = 'none';
        document.getElementById('calendarButtonBoats').style.display = 'none';
        const notice = document.getElementById('calendarNotice');
        if (notice) {
            notice.style.display = 'block';
            notice.innerHTML = '⏳ Loading filings... Calendar will be available once complete';
        }
        
        const startDate = `${year}-${String(month).padStart(2, '0')}-01`;
        const lastDay = new Date(year, month, 0).getDate();
        const endDate = `${year}-${String(month).padStart(2, '0')}-${lastDay}`;
        
        console.log('Date range:', startDate, 'to', endDate);
        
        const isUnlimited = recordsOption === 'unlimited';
        
        try {
            let allFilings = [];
            
            // First, ALWAYS count the total when unlimited is selected
            if (isUnlimited) {
                progressContainer.style.display = 'block';
                document.getElementById('progressText').textContent = 'Counting total filings...';
                
                let formTypes = formType === 'all' ? ['3', '4', '5', '144'] : [formType];
                const totalCount = await getTotalCount(formTypes, startDate, endDate);
                
                console.log(`Total count: ${totalCount}`);
                displayCountInfo(totalCount, formType, year, month);
                
                // Wait a moment for user to see the count
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                if (formType === 'all') {
                    // Process each form type separately
                    let totalFetched = 0;
                    
                    for (const singleForm of formTypes) {
                        console.log(`Processing Form ${singleForm}...`);
                        document.getElementById('progressText').textContent = `Analyzing Form ${singleForm} filings...`;
                        
                        // Get count for this specific form
                        const formCount = await getTotalCount(singleForm, startDate, endDate);
                        
                        if (formCount === 0) {
                            console.log(`No Form ${singleForm} filings found`);
                            continue;
                        }
                        
                        console.log(`Form ${singleForm}: ${formCount} filings`);
                        
                        // Create chunks for this form type
                        const chunks = createDateChunks(startDate, endDate, formCount, 9500);
                        console.log(`Form ${singleForm} will be fetched in ${chunks.length} chunks`);
                        
                        if (chunks.length > 1) {
                            displayChunkProgress(chunks, -1, singleForm);
                        }
                        
                        for (let i = 0; i < chunks.length; i++) {
                            if (chunks.length > 1) {
                                displayChunkProgress(chunks, i, singleForm);
                            }
                            
                            document.getElementById('progressText').textContent = 
                                `Form ${singleForm}: Fetching ${chunks[i].dateRange}...`;
                            
                            const chunkFilings = await fetchChunk(singleForm, chunks[i], (current, total, dateRange) => {
                                document.getElementById('progressText').textContent = 
                                    `Form ${singleForm} (${dateRange}): ${current}/${total} records`;
                            });
                            
                            allFilings = allFilings.concat(chunkFilings);
                            totalFetched += chunkFilings.length;
                            
                            if (chunks.length > 1) {
                                await new Promise(resolve => setTimeout(resolve, 500));
                            }
                        }
                        
                        document.getElementById('progressText').textContent = 
                            `Completed Form ${singleForm}: ${formCount.toLocaleString()} filings`;
                        await new Promise(resolve => setTimeout(resolve, 500));
                    }
                    
                    document.getElementById('progressText').textContent = 
                        `Complete! Fetched ${totalFetched.toLocaleString()} filings across all form types`;
                    
                } else {
                    // Single form type - but still chunk if needed
                    const chunks = createDateChunks(startDate, endDate, totalCount, 9500);
                    console.log(`Will fetch in ${chunks.length} chunks`);
                    
                    if (chunks.length > 1) {
                        displayChunkProgress(chunks, -1, formType);
                    }
                    
                    for (let i = 0; i < chunks.length; i++) {
                        if (chunks.length > 1) {
                            displayChunkProgress(chunks, i, formType);
                        }
                        
                        document.getElementById('progressText').textContent = 
                            `Fetching ${chunks[i].dateRange}...`;
                        
                        const chunkFilings = await fetchChunk(formType, chunks[i], (current, total, dateRange) => {
                            document.getElementById('progressText').textContent = 
                                `${dateRange}: ${current.toLocaleString()}/${total.toLocaleString()} records`;
                        });
                        
                        allFilings = allFilings.concat(chunkFilings);
                        
                        if (chunks.length > 1) {
                            await new Promise(resolve => setTimeout(resolve, 500));
                        }
                    }
                    
                    showNotification(`✅ Successfully fetched ${allFilings.length.toLocaleString()} filings!`);
                }
                
            } else {
                // Limited fetch - but still show progress with chunks for visibility
                progressContainer.style.display = 'block';
                const targetRecords = parseInt(recordsOption);
                
                // Create a single "chunk" for display purposes
                const chunks = [{
                    start: startDate,
                    end: endDate,
                    estimatedCount: targetRecords,
                    dateRange: `${startDate} to ${endDate}`
                }];
                
                displayChunkProgress(chunks, 0, formType);
                
                if (formType === 'all') {
                    // Fetch limited records across all forms
                    const formTypes = ['3', '4', '5', '144'];
                    const recordsPerForm = Math.ceil(targetRecords / 4);
                    
                    for (const singleForm of formTypes) {
                        document.getElementById('progressText').textContent = 
                            `Fetching Form ${singleForm} (limited to ${recordsPerForm} records)...`;
                        
                        const formFilings = await fetchSingleFormType(singleForm, startDate, endDate, progressContainer, recordsPerForm);
                        allFilings = allFilings.concat(formFilings);
                    }
                } else {
                    // Single form type limited fetch
                    document.getElementById('progressText').textContent = 
                        `Fetching ${targetRecords} Form ${formType} records...`;
                    
                    allFilings = await fetchSingleFormType(formType, startDate, endDate, progressContainer, targetRecords);
                }
                
                showNotification(`✅ Successfully loaded ${allFilings.length} filings`);
            }
            
            console.log(`Total filings fetched: ${allFilings.length}`);
            
            if (allFilings.length > 0) {
                filings = allFilings;
                
                // Update calendar month/year to match fetched data
                currentCalendarMonth = parseInt(month) - 1;
                currentCalendarYear = parseInt(year);
                
                displayFilings(allFilings);
                displayStats(allFilings);
                
                document.getElementById('exportSection').style.display = 'block';
                
                // Show calendar buttons ONLY after successful data fetch
                document.getElementById('calendarButtonCards').style.display = 'inline-block';
                document.getElementById('calendarButtonBoats').style.display = 'inline-block';
                
                // Hide the calendar notice
                const notice = document.getElementById('calendarNotice');
                if (notice) notice.style.display = 'none';
                
                showNotification(`✅ Data loaded! Calendar is now available.`);
            } else {
                document.getElementById('cardsGrid').innerHTML = '<p style="color: white;">No filings found for selected period.</p>';
                // Keep calendar buttons hidden if no data
                document.getElementById('calendarButtonCards').style.display = 'none';
                document.getElementById('calendarButtonBoats').style.display = 'none';
            }
            
        } catch (error) {
            console.error('Error in fetchFilings:', error);
            document.getElementById('cardsGrid').innerHTML = `<p style="color: white;">Error fetching filings: ${error.message}</p>`;
            showNotification(`⌠Error: ${error.message}`);
            
            // Reset calendar notice on error
            const notice = document.getElementById('calendarNotice');
            if (notice) {
                notice.style.display = 'block';
                notice.innerHTML = '📅 Calendar will be available after fetching filings';
            }
        } finally {
            loadingDiv.style.display = 'none';
            progressContainer.style.display = 'none';
            chunkProgress.style.display = 'none';
            countDisplay.style.display = 'none';
            button.disabled = false;
        }
    };
        
        async function fetchSingleFormType(formType, startDate, endDate, progressContainer, recordLimit) {
            const batchSize = 50;
            let allFilings = [];
            let fetchedCount = 0;
            
            // Use correct endpoint based on form type
            const endpoint = formType === '144' 
                ? 'https://api.sec-api.io/form-144'
                : 'https://api.sec-api.io/insider-trading';

            console.log(`Using endpoint: ${endpoint} for Form ${formType}`);

            const targetRecords = Math.min(recordLimit, 10000); // Max 10k per single query

            try {
                // Use correct query field based on form type
                const queryField = formType === '144' ? 'formType' : 'documentType';
                
                let batchCount = 0;
                while (fetchedCount < targetRecords) {
                    const fromIndex = batchCount * batchSize;
                    
                    if (fromIndex >= 10000) {
                        console.log('Reached API limit of 10000');
                        break;
                    }
                    
                    const currentBatchSize = Math.min(batchSize, targetRecords - fetchedCount);
                    
                    const payload = {
                        query: `${queryField}:${formType} AND filedAt:[${startDate} TO ${endDate}]`,
                        from: fromIndex.toString(),
                        size: currentBatchSize.toString(),
                        sort: [{ "filedAt": { "order": "desc" }}]
                    };
                    
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': API_KEY
                        },
                        body: JSON.stringify(payload)
                    });
                    
                    if (!response.ok) {
                        console.error(`Batch ${batchCount + 1} failed with status ${response.status}`);
                        break;
                    }
                    
                    const data = await response.json();
                    const results = data.transactions || data.data || [];
                    
                    if (results.length > 0) {
                        allFilings = allFilings.concat(results);
                        fetchedCount += results.length;
                        batchCount++;
                        
                        document.getElementById('progressText').textContent = 
                            `Form ${formType}: ${fetchedCount} of ${targetRecords} records`;
                        
                        if (results.length < currentBatchSize) {
                            break;
                        }
                    } else {
                        break;
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, 200));
                }
                
            } catch (error) {
                console.error(`Error fetching Form ${formType}:`, error);
                throw error;
            }
            
            console.log(`Form ${formType} fetch complete: ${allFilings.length} filings`);
            return allFilings;
        }
        
        function displayFilings(filings) {
            const cardsGrid = document.getElementById('cardsGrid');
            cardsGrid.innerHTML = '';
            displayedFilings = 100; // Reset to initial display count
            
            // Remove any existing pagination info and load more button
            const existingInfo = document.querySelectorAll('.pagination-info, .load-more-container');
            existingInfo.forEach(el => el.remove());
            
            // Add pagination info
            const paginationInfo = document.createElement('div');
            paginationInfo.className = 'pagination-info';
            paginationInfo.style.cssText = 'color: white; text-align: center; margin-bottom: 20px; font-size: 18px; background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px;';
            
            const recordsOption = document.getElementById('recordsSelect').value;
            const formType = document.getElementById('formSelect').value;
            const isUnlimited = recordsOption === 'unlimited';
            
            if (isUnlimited) {
                const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
                const month = document.getElementById('monthSelect').value;
                const year = document.getElementById('yearSelect').value;
                const monthName = monthNames[parseInt(month) - 1];
                
                if (filings.length > 10000) {
                    paginationInfo.innerHTML = `
                        <strong>🚀 UNLIMITED DATA FETCHED!</strong><br>
                        <span style="font-size: 20px; color: #ffd700;">Total: ${filings.length.toLocaleString()} filings for ${monthName} ${year}</span><br>
                        <span style="font-size: 14px; color: #ffd700;">⚠️ Displaying first ${Math.min(100, filings.length)} cards (all ${filings.length.toLocaleString()} available for export)</span>
                    `;
                } else {
                    paginationInfo.innerHTML = `
                        <strong>📊 Complete Month Data</strong><br>
                        <span style="font-size: 16px;">Total: ${filings.length.toLocaleString()} filings for ${monthName} ${year}</span><br>
                        <span style="font-size: 14px; color: #ffd700;">Displaying first ${Math.min(100, filings.length)} cards</span>
                    `;
                }
            } else {
                paginationInfo.innerHTML = `
                    <strong>Displaying ${Math.min(100, filings.length)} of ${filings.length} filings</strong>
                    ${filings.length > 100 ? '<br><span style="font-size: 14px;">All data available for export</span>' : ''}
                `;
            }
            
            cardsGrid.parentElement.insertBefore(paginationInfo, cardsGrid);
            
            // Display only first 100 cards
            const filingsToDisplay = filings.slice(0, 100);
            filingsToDisplay.forEach(filing => {
                const card = createFilingCard(filing);
                cardsGrid.appendChild(card);
            });
            
            // Add Load More button if there are more than 100 filings
            if (filings.length > 100) {
                const loadMoreContainer = document.createElement('div');
                loadMoreContainer.className = 'load-more-container';
                loadMoreContainer.style.cssText = 'text-align: center; margin: 30px 0; padding: 20px;';
                loadMoreContainer.innerHTML = `
                    <button onclick="loadMoreCards()" style="
                        background: linear-gradient(135deg, #28a745, #20c997);
                        color: white;
                        padding: 15px 30px;
                        border: none;
                        border-radius: 8px;
                        font-size: 16px;
                        font-weight: bold;
                        cursor: pointer;
                        transition: all 0.3s;
                    ">
                        📋 Load Next 100 Cards (${Math.min(100, filings.length - displayedFilings)} remaining)
                    </button>
                    <p style="color: rgba(255,255,255,0.7); margin-top: 10px; font-size: 14px;">
                        Performance tip: Export data instead of loading all cards
                    </p>
                `;
                cardsGrid.parentElement.appendChild(loadMoreContainer);
            }
        }
        
        function loadMoreCards() {
            const cardsGrid = document.getElementById('cardsGrid');
            const startIndex = displayedFilings;
            const endIndex = Math.min(startIndex + 100, filings.length);
            
            // Add next batch of cards
            for (let i = startIndex; i < endIndex; i++) {
                const card = createFilingCard(filings[i]);
                cardsGrid.appendChild(card);
            }
            
            displayedFilings = endIndex;
            
            // Update or remove Load More button
            const loadMoreContainer = document.querySelector('.load-more-container');
            if (displayedFilings >= filings.length) {
                loadMoreContainer.innerHTML = `
                    <p style="color: #28a745; font-weight: bold;">
                        ✅ All ${filings.length.toLocaleString()} cards loaded
                    </p>
                `;
            } else {
                loadMoreContainer.querySelector('button').innerHTML = 
                    `📋 Load Next 100 Cards (${Math.min(100, filings.length - displayedFilings)} remaining)`;
            }
        }
        
        function createFilingCard(filing) {
            const card = document.createElement('div');
            card.className = 'filing-card';
            
            // Extract all CIKs from the filing
            const ciks = extractCIKs(filing);
            
            let html = `
                <div class="filing-header">
                    <span class="form-type">Form ${filing.formType || filing.documentType || ''}</span>
                    <span class="filing-date">${new Date(filing.filedAt).toLocaleDateString()}</span>
                </div>
            `;
            
            // Display Reporting Person CIK (Individual)
            if (ciks.reportingPerson) {
                html += `
                    <div class="cik-section">
                        <div class="cik-label">
                            <span class="emoji">👤</span> Reporting Person (Insider)
                            <button onclick="addToWatchlist('individual', '${ciks.reportingPerson.cik}', '${(ciks.reportingPerson.name || '').replace(/'/g, "\\'")}')" 
                                    style="background: #28a745; color: white; padding: 3px 10px; 
                                           border-radius: 5px; margin-left: 10px; border: none;
                                           font-size: 11px; cursor: pointer; font-weight: bold;">
                                + Watchlist
                            </button>
                        </div>
                        <div class="cik-info">
                            <div class="cik-number">
                                CIK: <a href="https://www.sec.gov/cgi-bin/browse-edgar?CIK=${ciks.reportingPerson.cik}" 
                                        target="_blank" 
                                        title="${ciks.reportingPerson.name} OTCV"
                                        style="color: #667eea; font-weight: bold; text-decoration: none;">
                                    ${ciks.reportingPerson.cik}
                                </a>
                            </div>
                            <div class="cik-name">${ciks.reportingPerson.name}</div>
                            <div class="cik-links">
                                <a href="https://www.sec.gov/cgi-bin/browse-edgar?CIK=${ciks.reportingPerson.cik}" 
                                   target="_blank" class="cik-link" 
                                   title="${ciks.reportingPerson.name} OTCV">
                                   ${ciks.reportingPerson.name.split(' ').slice(0, 2).join(' ')} OTCV
                                </a>
                                <a href="https://www.sec.gov/Archives/edgar/data/${ciks.reportingPerson.cik.replace(/^0+/, '')}/" 
                                   target="_blank" class="cik-link">All Filings</a>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Display Issuer/Company CIK
            if (ciks.issuer) {
                html += `
                    <div class="cik-section">
                        <div class="cik-label">
                            <span class="emoji">🏢</span> Issuer (Company)
                        </div>
                        <div class="cik-info">
                            <div class="cik-number">CIK: ${ciks.issuer.cik}</div>
                            <div class="cik-name">${ciks.issuer.name}</div>
                            ${ciks.issuer.ticker ? `
                                <div class="ticker-hot">
                                    <span style="color: #667eea; font-weight: bold; font-size: 18px;">
                                        Ticker: ${ciks.issuer.ticker}
                                    </span>
                                    <button onclick="addToWatchlist('company', '${ciks.issuer.ticker}', '${(ciks.issuer.name || '').replace(/'/g, "\\'")}')" 
                                            style="background: #28a745; padding: 5px 10px; 
                                                   border-radius: 5px; margin-left: 10px; 
                                                   font-size: 12px; cursor: pointer; border: none; color: white; font-weight: bold;">
                                        + Watchlist
                                    </button>
                                    <div class="ticker-links">
                                        <a href="https://finance.yahoo.com/quote/${ciks.issuer.ticker}" 
                                           target="_blank" class="ticker-link yahoo">📈 Yahoo</a>
                                        <a href="https://www.google.com/finance/quote/${ciks.issuer.ticker}:NYSE" 
                                           target="_blank" class="ticker-link google">📊 Google</a>
                                        <a href="https://www.tradingview.com/chart/?symbol=${ciks.issuer.ticker}" 
                                           target="_blank" class="ticker-link tradingview">📉 TradingView</a>
                                        <a href="https://stockcharts.com/h-sc/ui?s=${ciks.issuer.ticker}" 
                                           target="_blank" class="ticker-link charts">📊 Charts</a>
                                        <a href="https://finviz.com/quote.ashx?t=${ciks.issuer.ticker}" 
                                           target="_blank" class="ticker-link finviz">🔍 Finviz</a>
                                        <a href="https://seekingalpha.com/symbol/${ciks.issuer.ticker}" 
                                           target="_blank" class="ticker-link seeking">📰 News</a>
                                    </div>
                                </div>
                            ` : ''}
                            <div class="cik-links">
                                <a href="https://www.sec.gov/cgi-bin/browse-edgar?CIK=${ciks.issuer.cik}" 
                                   target="_blank" class="cik-link">
                                   ${ciks.issuer.ticker ? `${ciks.issuer.ticker} OTCV` : 'SEC Profile'}
                                </a>
                                <a href="https://www.sec.gov/Archives/edgar/data/${ciks.issuer.cik.replace(/^0+/, '')}/" 
                                   target="_blank" class="cik-link">All Filings</a>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Link to actual filing - use HTML format
            const filingLink = filing.linkToFilingDetails || 
                              (filing.accessionNo ? `https://www.sec.gov/Archives/edgar/data/${ciks.issuer?.cik || filing.cik}/${filing.accessionNo.replace(/-/g, '')}/${filing.accessionNo}-index.htm` : '#');
            html += `
                <a href="${filingLink}" target="_blank" class="filing-link">
                    📄 View Full Filing
                </a>
            `;
            
            card.innerHTML = html;
            return card;
        }
        
        function extractCIKs(filing) {
            const ciks = {
                reportingPerson: null,
                issuer: null
            };
            
            // Handle Form 3/4/5 structure (from insider-trading API)
            if (filing.reportingOwner && filing.issuer) {
                ciks.reportingPerson = {
                    cik: filing.reportingOwner.cik,
                    name: filing.reportingOwner.name
                };
                ciks.issuer = {
                    cik: filing.issuer.cik,
                    name: filing.issuer.name,
                    ticker: filing.issuer.tradingSymbol || null
                };
                return ciks;
            }
            
            // Handle Form 144 structure (from form-144 API)
            if (filing.issuerInfo) {
                // For Form 144, the reporting person info is in issuerInfo
                ciks.reportingPerson = {
                    cik: filing.entities?.find(e => e.companyName?.includes('(Reporting)'))?.cik || '',
                    name: filing.issuerInfo.nameOfPersonForWhoseAccountTheSecuritiesAreToBeSold || 'Unknown'
                };
                ciks.issuer = {
                    cik: filing.issuerInfo.issuerCik || filing.entities?.[0]?.cik || '',
                    name: filing.issuerInfo.issuerName || filing.entities?.[0]?.companyName || 'Unknown',
                    ticker: filing.issuerInfo.issuerTicker || filing.entities?.[0]?.ticker || null
                };
                return ciks;
            }
            
            // Original entity-based extraction (fallback)
            if (filing.entities && filing.entities.length > 0) {
                filing.entities.forEach(entity => {
                    const entityName = entity.companyName || '';
                    
                    if (entityName.includes('(Reporting)')) {
                        ciks.reportingPerson = {
                            cik: entity.cik || filing.cik,
                            name: entityName.replace('(Reporting)', '').trim()
                        };
                    } else if (entityName.includes('(Issuer)') || entityName.includes('(Subject)')) {
                        ciks.issuer = {
                            cik: entity.cik || filing.cik,
                            name: entityName.replace('(Issuer)', '').replace('(Subject)', '').trim(),
                            ticker: entity.ticker || filing.ticker || null
                        };
                    }
                });
            }
            
            // Final fallback to main filing info
            if (!ciks.issuer && filing.cik) {
                ciks.issuer = {
                    cik: filing.cik,
                    name: filing.companyName || filing.companyNameLong || 'Unknown',
                    ticker: filing.ticker || null
                };
            }
            
            return ciks;
        }
        
        // Updated createFilingBoat with date display
        function createFilingBoat(filing, index) {
            const boat = document.createElement('div');
            boat.className = 'filing-boat';
            
            const ciks = extractCIKs(filing);
            
            // Add filing date at the top
            const filingDate = new Date(filing.filedAt).toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric',
                year: 'numeric'
            });
            
            let html = `
                <div class="boat-form">${filing.formType || filing.documentType || ''}</div>
                <div style="text-align: center; color: #667eea; font-weight: bold; font-size: 11px; margin-bottom: 5px; border-bottom: 1px solid #e0e0e0; padding-bottom: 3px;">
                    📅 ${filingDate}
                </div>
            `;
            
            if (ciks.reportingPerson) {
                html += `
                    <div class="boat-cik">👤 ${ciks.reportingPerson.cik}</div>
                    <div class="boat-name">${ciks.reportingPerson.name}</div>
                `;
            }
            
            if (ciks.issuer) {
                html += `
                    <div class="boat-cik">🏢 ${ciks.issuer.cik}</div>
                    <div class="boat-name">${ciks.issuer.name}</div>
                `;
                
                if (ciks.issuer.ticker) {
                    html += `<div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 3px 8px; border-radius: 5px; margin-top: 5px; font-size: 11px; font-weight: bold; text-align: center;">📈 ${ciks.issuer.ticker}</div>`;
                }
            }
            
            boat.innerHTML = html;
            boat.style.cursor = 'pointer';
            boat.title = 'Click to view filing';
            
            // Add click handler to open filing - HTML format
            const filingLink = filing.linkToFilingDetails || 
                              (filing.accessionNo ? `https://www.sec.gov/Archives/edgar/data/${ciks.issuer?.cik || filing.cik}/${filing.accessionNo.replace(/-/g, '')}/${filing.accessionNo}-index.htm` : '#');
            boat.onclick = () => {
                window.open(filingLink, '_blank');
            };
            
            return boat;
        }
        
        function displayStats(filings) {
            const statsDiv = document.getElementById('statsDiv');
            
            // Count unique CIKs and tickers
            const uniqueReportingCIKs = new Set();
            const uniqueIssuerCIKs = new Set();
            const uniqueTickers = new Set();
            const formCounts = {};
            
            filings.forEach(filing => {
                const ciks = extractCIKs(filing);
                if (ciks.reportingPerson) uniqueReportingCIKs.add(ciks.reportingPerson.cik);
                if (ciks.issuer) {
                    uniqueIssuerCIKs.add(ciks.issuer.cik);
                    if (ciks.issuer?.ticker) uniqueTickers.add(ciks.issuer.ticker);
                }
                
                // Count form types
                const formType = filing.formType || filing.documentType || 'Unknown';
                formCounts[formType] = (formCounts[formType] || 0) + 1;
            });
            
            // Create ticker pills (limit to first 20 for display)
            let tickerPills = '';
            const tickerArray = Array.from(uniqueTickers).slice(0, 20);
            tickerArray.forEach(ticker => {
                tickerPills += `
                    <a href="https://finance.yahoo.com/quote/${ticker}" target="_blank" 
                       style="display: inline-block; background: linear-gradient(135deg, #667eea, #764ba2); 
                              color: white; padding: 5px 12px; border-radius: 15px; margin: 3px;
                              text-decoration: none; font-weight: bold; font-size: 12px;
                              transition: transform 0.2s;">
                        ${ticker}
                    </a>
                `;
            });
            
            if (uniqueTickers.size > 20) {
                tickerPills += `<span style="display: inline-block; padding: 5px 12px; margin: 3px; color: #667eea;">
                    +${uniqueTickers.size - 20} more...
                </span>`;
            }
            
            // Create form type breakdown
            let formBreakdown = '';
            Object.entries(formCounts).forEach(([form, count]) => {
                formBreakdown += `<span style="margin-right: 15px;">Form ${form}: <strong>${count.toLocaleString()}</strong></span>`;
            });
            
            // Check fetch method
            const recordsOption = document.getElementById('recordsSelect').value;
            const formType = document.getElementById('formSelect').value;
            const isUnlimited = recordsOption === 'unlimited';
            
            let statusText = '';
            if (isUnlimited) {
                statusText = '<span style="color: #28a745; font-weight: bold;">(Complete data for month)</span>';
            }
            
            statsDiv.innerHTML = `
                <h3>📊 OllyTracker Filing Statistics ${isUnlimited ? '- UNLIMITED Data' : ''}</h3>
                <p>Total Filings: <strong style="color: #667eea; font-size: 20px;">${filings.length.toLocaleString()}</strong> ${statusText}</p>
                <p>Form Breakdown: ${formBreakdown}</p>
                <p>Unique Reporting Persons: <strong>${uniqueReportingCIKs.size.toLocaleString()}</strong></p>
                <p>Unique Issuers: <strong>${uniqueIssuerCIKs.size.toLocaleString()}</strong></p>
                <p>Active Tickers: <strong>${uniqueTickers.size.toLocaleString()}</strong></p>
               
                ${tickerPills ? `<div style="margin-top: 10px;"><strong>Hot Tickers:</strong><br>${tickerPills}</div>` : ''}
            `;
            
            statsDiv.style.display = 'block';
        }
        
        // Updated Export function with day export support
        function exportCurrentData(format, isDayExport = false) {
            // Use filtered filings if date is selected and isDayExport is true
            const exportFilings = (isDayExport && selectedDate && filteredFilings.length > 0) ? filteredFilings : filings;
            
            if (!exportFilings || exportFilings.length === 0) {
                showNotification('⌠No data to export');
                return;
            }
            
            const year = document.getElementById('yearSelect').value;
            const month = document.getElementById('monthSelect').value;
            const formType = document.getElementById('formSelect').value;
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const monthName = monthNames[parseInt(month) - 1];
            
            let filename = `OllyInsider_${monthName}${year}_${formType}_${exportFilings.length}records`;
            if (isDayExport && selectedDate) {
                filename += `_${selectedDate.toISOString().split('T')[0]}`;
            }
            
            let content, mimeType;
            
            // Group filings by form type for better organization
            const groupedFilings = {};
            exportFilings.forEach(filing => {
                const ft = filing.formType || filing.documentType || 'Unknown';
                if (!groupedFilings[ft]) {
                    groupedFilings[ft] = [];
                }
                groupedFilings[ft].push(filing);
            });
            
            switch(format) {
                case 'json':
                    content = JSON.stringify({
                        metadata: {
                            exportDate: new Date().toISOString(),
                            year: year,
                            month: month,
                            formType: formType,
                            totalFilings: exportFilings.length,
                            isUnlimited: exportFilings.length > 10000,
                            selectedDate: (isDayExport && selectedDate) ? selectedDate.toISOString() : null,
                            formTypeSummary: Object.keys(groupedFilings).map(ft => ({
                                formType: ft,
                                count: groupedFilings[ft].length
                            }))
                        },
                        allFilings: exportFilings
                    }, null, 2);
                    filename += '.json';
                    mimeType = 'application/json';
                    break;
                    
                case 'csv':
                    // CSV-specific code - FIXED
                    let csvContent = `OllyInsider Export for,${monthName},${year}\n`;
                    csvContent += `Form ${formType},"${exportFilings.length.toLocaleString()}",Records\n`;
                    
                    // Add copyright line with current date/time
                    const now2 = new Date();
                    const dateStr2 = now2.toLocaleDateString();
                    const timeStr2 = now2.toLocaleTimeString();
                    csvContent += `© OllyTracker™,all rights reserved 2025,ollytracker.com,Exported: ${dateStr2} ${timeStr2}\n`;
                    
                    csvContent += '\n'; // Empty row
                    csvContent += 'Filing Date,Form Type,Form Description,Reporting CIK,Reporting Name,Issuer CIK,Issuer Name,Ticker,SEC Filing Link\n';
                    
                    // Sort filings by form type, then by date
                    const sortedFilingsCSV = exportFilings.sort((a, b) => {
                        const aType = a.formType || a.documentType || 'Unknown';
                        const bType = b.formType || b.documentType || 'Unknown';
                        if (aType !== bType) {
                            return aType.localeCompare(bType);
                        }
                        return new Date(b.filedAt) - new Date(a.filedAt);
                    });

                    // Add actual data rows - Using sortedFilingsCSV
                    sortedFilingsCSV.forEach(filing => {
                        const ciks = extractCIKs(filing);
                        const formDescription = getFormDescription(filing.formType || filing.documentType || 'Unknown');
                        const row = [
                            new Date(filing.filedAt).toLocaleDateString(),
                            filing.formType || filing.documentType || 'Unknown',
                            formDescription,
                            ciks.reportingPerson?.cik || '',
                            `"${(ciks.reportingPerson?.name || '').replace(/"/g, '""')}"`, // Escape quotes
                            ciks.issuer?.cik || '',
                            `"${(ciks.issuer?.name || '').replace(/"/g, '""')}"`, // Escape quotes
                            ciks.issuer?.ticker || '',
                            filing.linkToFilingDetails || filing.accessionNo || ''
                        ];
                        csvContent += row.join(',') + '\n';
                    });
                    
                    content = csvContent;
                    filename += '.csv';
                    mimeType = 'text/csv';
                    break;

                case 'excel':
                    // Create a new workbook
                    const wb = XLSX.utils.book_new();
                    
                    // Prepare data array for Excel
                    const excelData = [];
                        
                    // Add header rows
                    excelData.push(['OllyInsider Export for', monthName, year]);
                    excelData.push(['Form ' + formType, exportFilings.length.toLocaleString(), 'Records']);
                        
                    // Add copyright line with current date/time
                    const now = new Date();
                    const dateStr = now.toLocaleDateString();
                    const timeStr = now.toLocaleTimeString();
                    excelData.push(['© OllyTracker™', 'all rights reserved 2025', 'ollytracker.com', `Exported: ${dateStr} ${timeStr}`]);
                        
                    // Add UNLIMITED MODE if applicable
                    if (exportFilings.length > 10000) {
                        excelData.push(['UNLIMITED MODE', `Successfully fetched ${exportFilings.length.toLocaleString()} records!`, '🚀']);
                    }
                        
                    // Add form type summary if mixed
                    if (Object.keys(groupedFilings).length > 1) {
                        const formSummary = Object.keys(groupedFilings).sort().map(ft => `Form ${ft} (${groupedFilings[ft].length.toLocaleString()})`).join(', ');
                        excelData.push(['Form Types:', formSummary]);
                    }
                        
                    // Add empty row
                    excelData.push([]);
                        
                    // Add column headers
                    excelData.push(['Filing Date', 'Form Type', 'Form Description', 'Reporting CIK', 'Reporting Name', 
                                        'Issuer CIK', 'Issuer Name', 'Ticker', 'SEC Filing Link']);
                        
                    // Sort filings by form type, then by date
                    const sortedFilings = exportFilings.sort((a, b) => {
                        const aType = a.formType || a.documentType || 'Unknown';
                        const bType = b.formType || b.documentType || 'Unknown';
                        if (aType !== bType) {
                            return aType.localeCompare(bType);
                        }
                        return new Date(b.filedAt) - new Date(a.filedAt);
                    });
                        
                    // Add data rows
                    sortedFilings.forEach(filing => {
                        const ciks = extractCIKs(filing);
                        const formDescription = getFormDescription(filing.formType || filing.documentType || 'Unknown');
                        excelData.push([
                            new Date(filing.filedAt).toLocaleDateString(),
                            filing.formType || filing.documentType || 'Unknown',
                            formDescription,
                            ciks.reportingPerson?.cik || '',
                            ciks.reportingPerson?.name || '',
                            ciks.issuer?.cik || '',
                            ciks.issuer?.name || '',
                            ciks.issuer?.ticker || '',
                            filing.linkToFilingDetails || filing.accessionNo || ''
                        ]);
                    });
                        
                    // Create worksheet from data
                    const ws = XLSX.utils.aoa_to_sheet(excelData);
                    
                    // Add worksheet to workbook
                    XLSX.utils.book_append_sheet(wb, ws, "Insider Filings");
                    
                    // Generate Excel file
                    XLSX.writeFile(wb, `${filename}.xlsx`);
                     
                    const exportMsg = exportFilings.length > 10000 ? 
                        `🚀 Exported ${exportFilings.length.toLocaleString()} UNLIMITED filings as Excel!` :
                        `✅ Exported ${exportFilings.length.toLocaleString()} filings as Excel`;
                    showNotification(exportMsg);
                    return;
            }
            
            // Download file (for JSON and CSV)
            const blob = new Blob([content], { type: mimeType });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            const exportMsg = exportFilings.length > 10000 ? 
                `🚀 Exported ${exportFilings.length.toLocaleString()} UNLIMITED filings as ${format.toUpperCase()}!` :
                `✅ Exported ${exportFilings.length.toLocaleString()} filings as ${format.toUpperCase()}`;
            showNotification(exportMsg);
        }
        
        function getFormDescription(formType) {
            const descriptions = {
                '3': 'Initial Ownership',
                '4': 'Change in Ownership',
                '5': 'Annual Statement',
                '144': 'Notice of Sale'
            };
            return descriptions[formType] || 'Other';
        }
        
        // Make functions globally available
        window.exportCurrentData = exportCurrentData;
        window.exportDayData = exportDayData;
        window.showWatchlist = showWatchlist;
        window.addToWatchlist = addToWatchlist;
        window.toggleView = toggleView;
        window.loadMoreCards = loadMoreCards;
        window.openCalendar = openCalendar;
        window.closeCalendar = closeCalendar;
        window.applyDateFilter = applyDateFilter;
        window.previousMonth = previousMonth;
        window.nextMonth = nextMonth;
        window.currentMonth = currentMonth;
    </script>
</body>
</html>